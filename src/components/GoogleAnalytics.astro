---
// Google Analytics 4 Component
// Replace GA_MEASUREMENT_ID with your actual GA4 measurement ID
const GA_MEASUREMENT_ID = 'G-XXXXXXXXXX'; // TODO: Replace with actual GA4 ID
---

<!-- Google Analytics 4 -->
<script is:inline define:vars={{ GA_MEASUREMENT_ID }}>
  // Only load GA if cookies are accepted
  function loadGoogleAnalytics() {
    // Check if consent was given
    const consent = document.cookie.split(';').find(c => c.trim().startsWith('nexify_cookie_consent='));
    const consentValue = consent ? consent.split('=')[1] : null;
    
    if (consentValue !== 'accepted') {
      // Set default consent to denied
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('consent', 'default', {
        'analytics_storage': 'denied'
      });
      return;
    }

    // Load GA script
    const script = document.createElement('script');
    script.async = true;
    script.src = `https://www.googletagmanager.com/gtag/js?id=${GA_MEASUREMENT_ID}`;
    document.head.appendChild(script);

    window.dataLayer = window.dataLayer || [];
    function gtag(){dataLayer.push(arguments);}
    window.gtag = gtag;
    
    gtag('js', new Date());
    gtag('config', GA_MEASUREMENT_ID, {
      'anonymize_ip': true,
      'cookie_flags': 'SameSite=None;Secure'
    });
  }

  // Load on page load
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', loadGoogleAnalytics);
  } else {
    loadGoogleAnalytics();
  }
</script>

<!-- Fallback noscript tracking pixel -->
<noscript>
  <img 
    src={`https://www.googletagmanager.com/ns.html?id=${GA_MEASUREMENT_ID}`}
    height="1" 
    width="1" 
    style="display:none;visibility:hidden"
    alt=""
  />
</noscript>
