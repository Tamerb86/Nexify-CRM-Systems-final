---
import { type Language } from '../lib/i18n';
import { Send, CheckCircle, AlertCircle, Loader2 } from 'lucide-astro';

interface Props {
  lang: Language;
  translations: any;
}

const { lang, translations: t } = Astro.props;
const isRTL = lang === 'ar';

// Formspree endpoint - Replace with your actual Formspree form ID
const FORMSPREE_ENDPOINT = 'https://formspree.io/f/YOUR_FORM_ID'; // TODO: Replace with actual Formspree ID
---

<div class="bg-gray-50 rounded-2xl p-8 lg:p-12">
  <h2 class={`text-2xl font-bold text-gray-900 mb-6 ${isRTL ? 'text-right' : 'text-left'}`}>
    {t.contact.form.title}
  </h2>
  
  <!-- Success Message -->
  <div id="form-success" class="hidden mb-6 p-4 bg-green-50 border border-green-200 rounded-xl">
    <div class={`flex items-center gap-3 ${isRTL ? 'flex-row-reverse' : ''}`}>
      <CheckCircle class="w-6 h-6 text-green-500 flex-shrink-0" />
      <p class="text-green-700 font-medium">{t.contact.form.success}</p>
    </div>
  </div>
  
  <!-- Error Message -->
  <div id="form-error" class="hidden mb-6 p-4 bg-red-50 border border-red-200 rounded-xl">
    <div class={`flex items-center gap-3 ${isRTL ? 'flex-row-reverse' : ''}`}>
      <AlertCircle class="w-6 h-6 text-red-500 flex-shrink-0" />
      <p class="text-red-700 font-medium" id="error-message">
        {lang === 'no' ? 'Noe gikk galt. Prøv igjen.' : lang === 'en' ? 'Something went wrong. Please try again.' : 'حدث خطأ ما. يرجى المحاولة مرة أخرى.'}
      </p>
    </div>
  </div>
  
  <form 
    id="contact-form" 
    action={FORMSPREE_ENDPOINT}
    method="POST"
    class="space-y-6"
  >
    <!-- Hidden fields for Formspree -->
    <input type="hidden" name="_subject" value="New Contact Form Submission - Nexify CRM" />
    <input type="hidden" name="_language" value={lang} />
    <input type="text" name="_gotcha" style="display:none" /> <!-- Honeypot -->
    
    <div class="grid md:grid-cols-2 gap-6">
      <!-- Name -->
      <div>
        <label class={`block text-sm font-medium text-gray-700 mb-2 ${isRTL ? 'text-right' : 'text-left'}`}>
          {t.contact.form.name.label} <span class="text-red-500">*</span>
        </label>
        <input 
          type="text" 
          name="name"
          required
          minlength="2"
          placeholder={t.contact.form.name.placeholder}
          class={`w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-primary focus:ring-2 focus:ring-primary/20 outline-none transition-all ${isRTL ? 'text-right' : 'text-left'}`}
        />
      </div>
      
      <!-- Email -->
      <div>
        <label class={`block text-sm font-medium text-gray-700 mb-2 ${isRTL ? 'text-right' : 'text-left'}`}>
          {t.contact.form.email.label} <span class="text-red-500">*</span>
        </label>
        <input 
          type="email" 
          name="email"
          required
          placeholder={t.contact.form.email.placeholder}
          class={`w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-primary focus:ring-2 focus:ring-primary/20 outline-none transition-all ${isRTL ? 'text-right' : 'text-left'}`}
        />
      </div>
    </div>
    
    <div class="grid md:grid-cols-2 gap-6">
      <!-- Phone -->
      <div>
        <label class={`block text-sm font-medium text-gray-700 mb-2 ${isRTL ? 'text-right' : 'text-left'}`}>
          {t.contact.form.phone.label}
        </label>
        <input 
          type="tel" 
          name="phone"
          placeholder={t.contact.form.phone.placeholder}
          class={`w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-primary focus:ring-2 focus:ring-primary/20 outline-none transition-all ${isRTL ? 'text-right' : 'text-left'}`}
        />
      </div>
      
      <!-- Company -->
      <div>
        <label class={`block text-sm font-medium text-gray-700 mb-2 ${isRTL ? 'text-right' : 'text-left'}`}>
          {t.contact.form.company.label}
        </label>
        <input 
          type="text" 
          name="company"
          placeholder={t.contact.form.company.placeholder}
          class={`w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-primary focus:ring-2 focus:ring-primary/20 outline-none transition-all ${isRTL ? 'text-right' : 'text-left'}`}
        />
      </div>
    </div>
    
    <!-- Service -->
    <div>
      <label class={`block text-sm font-medium text-gray-700 mb-2 ${isRTL ? 'text-right' : 'text-left'}`}>
        {t.contact.form.service.label}
      </label>
      <select 
        name="service"
        class={`w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-primary focus:ring-2 focus:ring-primary/20 outline-none transition-all bg-white ${isRTL ? 'text-right' : 'text-left'}`}
      >
        {t.contact.form.service.options.map((option: string, index: number) => (
          <option value={index === 0 ? '' : option}>{option}</option>
        ))}
      </select>
    </div>
    
    <!-- Budget -->
    <div>
      <label class={`block text-sm font-medium text-gray-700 mb-2 ${isRTL ? 'text-right' : 'text-left'}`}>
        {t.contact.form.budget.label}
      </label>
      <select 
        name="budget"
        class={`w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-primary focus:ring-2 focus:ring-primary/20 outline-none transition-all bg-white ${isRTL ? 'text-right' : 'text-left'}`}
      >
        {t.contact.form.budget.options.map((option: string, index: number) => (
          <option value={index === 0 ? '' : option}>{option}</option>
        ))}
      </select>
    </div>
    
    <!-- Message -->
    <div>
      <label class={`block text-sm font-medium text-gray-700 mb-2 ${isRTL ? 'text-right' : 'text-left'}`}>
        {t.contact.form.message.label} <span class="text-red-500">*</span>
      </label>
      <textarea 
        name="message"
        required
        minlength="10"
        rows="5"
        placeholder={t.contact.form.message.placeholder}
        class={`w-full px-4 py-3 rounded-xl border border-gray-200 focus:border-primary focus:ring-2 focus:ring-primary/20 outline-none transition-all resize-none ${isRTL ? 'text-right' : 'text-left'}`}
      ></textarea>
    </div>
    
    <!-- Submit Button -->
    <button 
      type="submit"
      id="submit-btn"
      class={`w-full px-6 py-4 bg-gradient-to-r from-primary to-teal-500 text-white font-medium rounded-xl hover:opacity-90 transition-all flex items-center justify-center gap-2 disabled:opacity-50 disabled:cursor-not-allowed ${isRTL ? 'flex-row-reverse' : ''}`}
    >
      <span id="btn-text" class={`flex items-center gap-2 ${isRTL ? 'flex-row-reverse' : ''}`}>
        <Send class="w-5 h-5" />
        {t.contact.form.submit}
      </span>
      <span id="btn-loading" class="hidden flex items-center gap-2">
        <svg class="animate-spin h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        {lang === 'no' ? 'Sender...' : lang === 'en' ? 'Sending...' : 'جاري الإرسال...'}
      </span>
    </button>
  </form>
</div>

<script>
  const form = document.getElementById('contact-form') as HTMLFormElement;
  const submitBtn = document.getElementById('submit-btn') as HTMLButtonElement;
  const btnText = document.getElementById('btn-text');
  const btnLoading = document.getElementById('btn-loading');
  const successMsg = document.getElementById('form-success');
  const errorMsg = document.getElementById('form-error');

  form?.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    // Show loading state
    submitBtn.disabled = true;
    btnText?.classList.add('hidden');
    btnLoading?.classList.remove('hidden');
    successMsg?.classList.add('hidden');
    errorMsg?.classList.add('hidden');
    
    try {
      const formData = new FormData(form);
      const response = await fetch(form.action, {
        method: 'POST',
        body: formData,
        headers: {
          'Accept': 'application/json'
        }
      });
      
      if (response.ok) {
        // Show success message
        successMsg?.classList.remove('hidden');
        form.reset();
        
        // Scroll to success message
        successMsg?.scrollIntoView({ behavior: 'smooth', block: 'center' });
        
        // Track conversion in GA
        if (typeof window.gtag === 'function') {
          window.gtag('event', 'form_submission', {
            'event_category': 'Contact',
            'event_label': 'Contact Form'
          });
        }
      } else {
        throw new Error('Form submission failed');
      }
    } catch (error) {
      // Show error message
      errorMsg?.classList.remove('hidden');
      console.error('Form submission error:', error);
    } finally {
      // Reset button state
      submitBtn.disabled = false;
      btnText?.classList.remove('hidden');
      btnLoading?.classList.add('hidden');
    }
  });
</script>
