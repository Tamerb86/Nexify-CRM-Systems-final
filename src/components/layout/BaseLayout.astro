---
import '../../styles/global.css';
import Header from './Header.astro';
import Footer from './Footer.astro';
import BackToTop from '../BackToTop.astro';
import PageProgress from '../PageProgress.astro';
import { languages, languagesList, urlStructure, getTranslations, type Language } from '../../lib/i18n';

interface Props {
  lang: Language;
  page: string;
  title?: string;
  description?: string;
  image?: string;
}

const { lang, page, title, description, image = '/images/og-image.png' } = Astro.props;

const t = getTranslations(lang);
const langConfig = languages[lang];
const dir = langConfig.dir;
const locale = langConfig.locale;

// SEO
const siteUrl = 'https://nexifyhub.no';
const pageUrl = `${siteUrl}${urlStructure[lang][page]}`;
const pageTitle = title || t.meta?.title || 'Nexify CRM Systems';
const pageDescription = description || t.meta?.description || 'Professional web development and SaaS solutions';

// Generate hreflang tags
const hreflangTags = languagesList.map(l => ({
  lang: l === 'no' ? 'nb' : l,
  href: `${siteUrl}${urlStructure[l][page]}`
}));

// JSON-LD Schema
const organizationSchema = {
  "@context": "https://schema.org",
  "@type": "Organization",
  "name": "Nexify CRM Systems AS",
  "url": siteUrl,
  "logo": `${siteUrl}/images/nexify-logo.png`,
  "description": "Professional web development, SaaS solutions, and digital services in Norway",
  "address": {
    "@type": "PostalAddress",
    "streetAddress": "Storgata 1",
    "addressLocality": "Oslo",
    "postalCode": "0155",
    "addressCountry": "NO"
  },
  "contactPoint": {
    "@type": "ContactPoint",
    "telephone": "+47-921-46-050",
    "contactType": "customer service",
    "availableLanguage": ["Norwegian", "English", "Arabic"]
  },
  "sameAs": [
    "https://www.linkedin.com/company/nexify-crm",
    "https://www.facebook.com/nexifycrm"
  ]
};

const websiteSchema = {
  "@context": "https://schema.org",
  "@type": "WebSite",
  "name": "Nexify CRM Systems",
  "url": siteUrl,
  "potentialAction": {
    "@type": "SearchAction",
    "target": `${siteUrl}/search?q={search_term_string}`,
    "query-input": "required name=search_term_string"
  }
};

const breadcrumbSchema = {
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position": 1,
      "name": t.nav?.home || "Home",
      "item": `${siteUrl}${urlStructure[lang].home}`
    },
    ...(page !== 'home' ? [{
      "@type": "ListItem",
      "position": 2,
      "name": t.nav?.[page] || page,
      "item": pageUrl
    }] : [])
  ]
};
---

<!DOCTYPE html>
<html lang={locale} dir={dir} class={dir === 'rtl' ? 'rtl' : 'ltr'}>
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <!-- Primary Meta Tags -->
  <title>{pageTitle}</title>
  <meta name="title" content={pageTitle} />
  <meta name="description" content={pageDescription} />
  <meta name="keywords" content="web development, SaaS, CRM, Shopify, Norway, Oslo, digital solutions" />
  <meta name="author" content="Nexify CRM Systems AS" />
  <meta name="robots" content="index, follow" />
  
  <!-- Canonical & Hreflang -->
  <link rel="canonical" href={pageUrl} />
  {hreflangTags.map(tag => (
    <link rel="alternate" hreflang={tag.lang} href={tag.href} />
  ))}
  <link rel="alternate" hreflang="x-default" href={`${siteUrl}${urlStructure['no'][page]}`} />
  
  <!-- Open Graph / Facebook -->
  <meta property="og:type" content="website" />
  <meta property="og:url" content={pageUrl} />
  <meta property="og:title" content={pageTitle} />
  <meta property="og:description" content={pageDescription} />
  <meta property="og:image" content={`${siteUrl}${image}`} />
  <meta property="og:locale" content={locale.replace('-', '_')} />
  <meta property="og:site_name" content="Nexify CRM Systems" />
  
  <!-- Twitter -->
  <meta property="twitter:card" content="summary_large_image" />
  <meta property="twitter:url" content={pageUrl} />
  <meta property="twitter:title" content={pageTitle} />
  <meta property="twitter:description" content={pageDescription} />
  <meta property="twitter:image" content={`${siteUrl}${image}`} />
  
  <!-- Favicon -->
  <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
  <link rel="icon" type="image/x-icon" href="/favicon.ico" />
  <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png" />
  
  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Work+Sans:wght@400;500;600;700&display=swap" rel="stylesheet" />
  
  <!-- JSON-LD Schema -->
  <script type="application/ld+json" set:html={JSON.stringify(organizationSchema)} />
  <script type="application/ld+json" set:html={JSON.stringify(websiteSchema)} />
  <script type="application/ld+json" set:html={JSON.stringify(breadcrumbSchema)} />
</head>
<body class={`font-sans antialiased ${dir === 'rtl' ? 'text-right' : 'text-left'}`}>
  <Header lang={lang} currentPage={page} />
  
  <main>
    <slot />
  </main>
  
  <Footer lang={lang} />
  <BackToTop />
  <PageProgress />
  
  <!-- Scroll Animations Script -->
  <script>
    // Intersection Observer for scroll animations
    const observerOptions = {
      root: null,
      rootMargin: '0px 0px -50px 0px',
      threshold: 0.1
    };

    const animateOnScroll = (entries, observer) => {
      entries.forEach((entry) => {
        if (entry.isIntersecting) {
          const parent = entry.target.parentElement;
          if (parent) {
            const siblings = Array.from(parent.querySelectorAll('.scroll-animate, .scroll-animate-left, .scroll-animate-right, .scroll-animate-scale'));
            const elementIndex = siblings.indexOf(entry.target);
            const delay = elementIndex * 100;
            setTimeout(() => entry.target.classList.add('visible'), delay);
          } else {
            entry.target.classList.add('visible');
          }
          observer.unobserve(entry.target);
        }
      });
    };

    const scrollObserver = new IntersectionObserver(animateOnScroll, observerOptions);

    document.addEventListener('DOMContentLoaded', () => {
      document.querySelectorAll('.scroll-animate, .scroll-animate-left, .scroll-animate-right, .scroll-animate-scale')
        .forEach(el => scrollObserver.observe(el));
    });

    // Sticky header effect
    const header = document.querySelector('.header-sticky');
    if (header) {
      window.addEventListener('scroll', () => {
        if (window.pageYOffset > 50) {
          header.classList.add('scrolled');
        } else {
          header.classList.remove('scrolled');
        }
      }, { passive: true });
    }

    // Counter animation
    const counterObserver = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          const target = parseInt(entry.target.getAttribute('data-count') || '0');
          let start = 0;
          const increment = target / 50;
          const updateCounter = () => {
            start += increment;
            if (start < target) {
              entry.target.textContent = Math.floor(start).toString();
              requestAnimationFrame(updateCounter);
            } else {
              entry.target.textContent = target.toString();
            }
          };
          updateCounter();
          counterObserver.unobserve(entry.target);
        }
      });
    }, { threshold: 0.5 });

    document.querySelectorAll('[data-count]').forEach(el => counterObserver.observe(el));
  </script>
</body>
</html>
